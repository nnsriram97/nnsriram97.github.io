/* ─────────────────────────────────────────────
   Thermal Canvas — 2D Heat Diffusion Simulation
   Renders a real-time heat equation on a full-page
   canvas behind the content, only in thermal mode.
   ───────────────────────────────────────────── */

(function () {
    'use strict';

    /* ── Magma colormap LUT (256 entries, sampled from matplotlib) ── */
    const MAGMA = [
        [0, 0, 4], [1, 0, 5], [1, 1, 6], [1, 1, 8], [2, 1, 10], [2, 2, 12], [2, 2, 14], [3, 2, 16],
        [4, 3, 18], [4, 3, 20], [5, 4, 23], [6, 4, 25], [7, 5, 27], [8, 5, 29], [9, 6, 32], [10, 7, 34],
        [11, 7, 37], [12, 8, 39], [14, 8, 42], [15, 9, 45], [16, 9, 47], [18, 10, 50], [19, 11, 53],
        [20, 11, 56], [22, 12, 59], [24, 12, 62], [25, 13, 65], [27, 13, 68], [29, 14, 71], [30, 14, 74],
        [32, 15, 78], [34, 15, 81], [36, 16, 84], [38, 16, 87], [40, 17, 90], [42, 17, 93], [44, 17, 96],
        [46, 17, 100], [48, 18, 103], [50, 18, 105], [52, 18, 108], [54, 19, 111], [56, 19, 113],
        [58, 19, 116], [59, 19, 118], [61, 19, 121], [63, 19, 123], [65, 20, 125], [67, 20, 127],
        [69, 20, 129], [70, 20, 131], [72, 20, 133], [74, 20, 134], [76, 20, 136], [78, 21, 137],
        [80, 21, 139], [81, 21, 140], [83, 21, 141], [85, 21, 142], [87, 22, 143], [89, 22, 144],
        [91, 22, 145], [92, 22, 146], [94, 23, 146], [96, 23, 147], [98, 23, 148], [100, 24, 148],
        [102, 24, 149], [103, 24, 149], [105, 25, 150], [107, 25, 150], [109, 26, 150], [111, 26, 151],
        [113, 27, 151], [114, 27, 151], [116, 28, 151], [118, 28, 151], [120, 29, 151], [122, 29, 152],
        [124, 30, 152], [125, 30, 152], [127, 31, 152], [129, 31, 152], [131, 32, 152], [133, 32, 152],
        [134, 33, 152], [136, 33, 152], [138, 34, 152], [140, 34, 151], [142, 35, 151], [144, 36, 151],
        [146, 36, 151], [147, 37, 151], [149, 37, 150], [151, 38, 150], [153, 39, 150], [155, 39, 149],
        [156, 40, 149], [158, 40, 149], [160, 41, 148], [162, 42, 148], [164, 42, 147], [165, 43, 147],
        [167, 44, 146], [169, 44, 146], [171, 45, 145], [172, 46, 145], [174, 46, 144], [176, 47, 143],
        [178, 48, 143], [179, 48, 142], [181, 49, 141], [183, 50, 141], [184, 51, 140], [186, 51, 139],
        [188, 52, 138], [189, 53, 138], [191, 54, 137], [193, 55, 136], [194, 55, 135], [196, 56, 134],
        [197, 57, 133], [199, 58, 132], [200, 59, 132], [202, 60, 131], [203, 61, 130], [205, 62, 129],
        [206, 63, 128], [208, 64, 127], [209, 65, 126], [210, 66, 125], [212, 67, 124], [213, 68, 123],
        [214, 70, 122], [215, 71, 121], [217, 72, 120], [218, 73, 119], [219, 74, 118], [220, 76, 117],
        [221, 77, 116], [222, 78, 115], [223, 80, 114], [224, 81, 113], [225, 82, 112], [226, 84, 111],
        [227, 85, 110], [228, 87, 109], [228, 88, 108], [229, 90, 107], [230, 91, 106], [230, 93, 105],
        [231, 94, 104], [232, 96, 103], [232, 97, 102], [233, 99, 101], [233, 101, 100], [234, 102, 99],
        [234, 104, 98], [235, 106, 97], [235, 108, 96], [236, 109, 95], [236, 111, 94], [236, 113, 93],
        [237, 115, 92], [237, 116, 91], [237, 118, 90], [238, 120, 89], [238, 122, 88], [238, 124, 87],
        [239, 126, 86], [239, 128, 85], [239, 130, 84], [240, 131, 83], [240, 133, 82], [240, 135, 81],
        [241, 137, 80], [241, 139, 79], [241, 141, 78], [241, 143, 77], [242, 145, 76], [242, 147, 75],
        [242, 149, 74], [243, 151, 73], [243, 153, 72], [243, 155, 71], [244, 157, 70], [244, 159, 69],
        [244, 161, 68], [244, 163, 67], [245, 165, 66], [245, 167, 65], [245, 169, 63], [245, 171, 62],
        [246, 173, 61], [246, 175, 60], [246, 177, 59], [247, 179, 58], [247, 181, 56], [247, 183, 55],
        [247, 185, 54], [248, 187, 53], [248, 189, 51], [248, 191, 50], [248, 193, 49], [249, 195, 47],
        [249, 197, 46], [249, 199, 45], [249, 201, 43], [250, 203, 42], [250, 205, 41], [250, 207, 39],
        [250, 209, 38], [251, 211, 36], [251, 213, 35], [251, 215, 33], [251, 217, 32], [252, 219, 30],
        [252, 221, 29], [252, 223, 27], [252, 225, 26], [253, 227, 24], [253, 229, 23], [253, 231, 21],
        [253, 233, 20], [254, 235, 18], [254, 237, 17], [254, 239, 16], [254, 241, 15], [254, 243, 14],
        [254, 245, 14], [254, 247, 14], [254, 249, 15], [254, 251, 16], [253, 253, 18], [253, 255, 20]
    ];

    /* ── Inferno colormap LUT (256 entries, sampled from matplotlib) ── */
    const INFERNO = [
        [0, 0, 4], [1, 0, 5], [1, 1, 7], [2, 1, 9], [2, 2, 11], [3, 2, 13], [3, 3, 15], [4, 3, 18],
        [4, 4, 20], [5, 4, 22], [6, 5, 24], [6, 5, 26], [7, 6, 28], [8, 6, 30], [9, 7, 32], [10, 7, 34],
        [11, 8, 36], [12, 9, 38], [13, 9, 40], [14, 10, 42], [15, 10, 44], [16, 11, 46], [17, 11, 48],
        [18, 12, 50], [20, 12, 52], [21, 13, 54], [22, 13, 56], [23, 14, 58], [24, 14, 60], [25, 15, 62],
        [27, 15, 64], [28, 16, 66], [29, 16, 68], [30, 17, 70], [32, 17, 72], [33, 17, 74], [34, 18, 76],
        [36, 18, 78], [37, 19, 80], [39, 19, 82], [40, 20, 84], [42, 20, 86], [43, 20, 88], [45, 21, 90],
        [46, 21, 92], [48, 22, 94], [49, 22, 96], [51, 22, 97], [53, 23, 99], [54, 23, 101], [56, 24, 103],
        [57, 24, 105], [59, 24, 107], [61, 25, 108], [62, 25, 110], [64, 25, 112], [66, 26, 114], [67, 26, 115],
        [69, 26, 117], [71, 27, 119], [72, 27, 120], [74, 28, 122], [76, 28, 123], [77, 28, 125], [79, 29, 126],
        [81, 29, 128], [82, 29, 129], [84, 30, 131], [86, 30, 132], [87, 31, 134], [89, 31, 135], [91, 31, 136],
        [92, 32, 138], [94, 32, 139], [96, 33, 140], [97, 33, 142], [99, 33, 143], [101, 34, 144], [102, 34, 146],
        [104, 35, 147], [106, 35, 148], [107, 35, 149], [109, 36, 151], [111, 36, 152], [112, 37, 153], [114, 37, 154],
        [115, 38, 155], [117, 38, 156], [119, 39, 158], [120, 39, 159], [122, 40, 160], [124, 40, 161], [125, 41, 162],
        [127, 41, 163], [129, 42, 164], [130, 42, 165], [132, 43, 166], [133, 43, 167], [135, 44, 168], [137, 44, 169],
        [138, 45, 170], [140, 46, 171], [142, 46, 172], [143, 47, 173], [145, 47, 174], [146, 48, 175], [148, 49, 175],
        [150, 49, 176], [151, 50, 177], [153, 51, 178], [154, 51, 179], [156, 52, 180], [158, 53, 180], [159, 53, 181],
        [161, 54, 182], [162, 55, 183], [164, 56, 183], [166, 56, 184], [167, 57, 185], [169, 58, 185], [170, 59, 186],
        [172, 60, 187], [173, 60, 187], [175, 61, 188], [177, 62, 188], [178, 63, 189], [180, 64, 189], [181, 65, 190],
        [183, 66, 190], [184, 67, 191], [186, 68, 191], [187, 69, 192], [189, 70, 192], [190, 71, 193], [192, 72, 193],
        [193, 73, 194], [195, 74, 194], [196, 75, 194], [198, 76, 195], [199, 77, 195], [201, 78, 195], [202, 79, 196],
        [204, 81, 196], [205, 82, 196], [206, 83, 197], [208, 84, 197], [209, 85, 197], [211, 86, 198], [212, 88, 198],
        [213, 89, 198], [215, 90, 199], [216, 91, 199], [217, 93, 199], [219, 94, 199], [220, 95, 200], [221, 97, 200],
        [223, 98, 200], [224, 99, 200], [225, 101, 200], [227, 102, 201], [228, 104, 201], [229, 105, 201], [230, 107, 201],
        [232, 108, 201], [233, 110, 201], [234, 111, 202], [235, 113, 202], [236, 114, 202], [238, 116, 202], [239, 117, 202],
        [240, 119, 202], [241, 121, 202], [242, 122, 202], [243, 124, 202], [244, 126, 202], [245, 127, 202], [246, 129, 202],
        [247, 131, 202], [248, 133, 202], [249, 134, 202], [250, 136, 202], [251, 138, 202], [252, 140, 202], [252, 141, 202],
        [253, 143, 201], [254, 145, 201], [254, 147, 201], [255, 149, 201], [255, 151, 200], [255, 153, 200], [255, 155, 200],
        [255, 156, 199], [255, 158, 199], [255, 160, 198], [255, 162, 198], [255, 164, 197], [255, 166, 197], [255, 168, 196],
        [255, 170, 196], [255, 172, 195], [255, 174, 194], [255, 176, 193], [255, 178, 193], [255, 180, 192], [255, 182, 191],
        [255, 184, 190], [255, 186, 190], [255, 188, 189], [255, 190, 188], [255, 192, 187], [255, 194, 186], [255, 196, 185],
        [255, 198, 184], [255, 200, 183], [255, 202, 182], [255, 204, 181], [255, 206, 180], [255, 208, 179], [255, 210, 178],
        [255, 212, 177], [254, 214, 175], [254, 216, 174], [254, 218, 173], [254, 220, 172], [254, 222, 170], [253, 224, 169],
        [253, 226, 168], [253, 228, 166], [253, 230, 165], [252, 232, 164], [252, 234, 162], [252, 235, 161], [251, 237, 159],
        [251, 239, 158], [251, 241, 156], [250, 243, 155], [250, 245, 153], [249, 247, 151], [249, 248, 150], [248, 250, 148],
        [248, 252, 146], [247, 254, 145], [247, 255, 143], [246, 255, 141], [245, 255, 140], [245, 255, 138], [244, 255, 136],
        [243, 255, 135], [243, 255, 133], [242, 255, 131], [241, 255, 129], [240, 255, 128], [240, 255, 126], [239, 255, 124],
        [238, 255, 122], [237, 255, 121], [237, 255, 119], [236, 255, 117], [235, 255, 115], [234, 255, 113], [233, 255, 112],
        [233, 255, 110], [232, 255, 108], [231, 255, 106], [230, 255, 104], [229, 255, 103], [229, 255, 101], [228, 255, 99],
        [227, 255, 97], [226, 255, 96], [225, 255, 94], [225, 255, 92], [224, 255, 90], [223, 255, 89], [222, 255, 87],
        [221, 255, 85], [221, 255, 84], [220, 255, 82], [219, 255, 80], [218, 255, 79], [217, 255, 77], [217, 255, 75],
        [216, 255, 74], [215, 255, 72], [214, 255, 71], [214, 255, 69], [213, 255, 68], [212, 255, 66], [211, 255, 65],
        [211, 255, 63], [210, 255, 62], [209, 255, 61], [208, 255, 59], [208, 255, 58], [207, 255, 57], [206, 255, 55],
        [206, 255, 54], [205, 255, 53], [204, 255, 52], [204, 255, 51], [203, 255, 50], [202, 255, 49], [202, 255, 48],
        [201, 255, 47], [200, 255, 46], [200, 255, 45], [199, 255, 44], [199, 255, 43], [198, 255, 42], [198, 255, 42],
        [197, 255, 41], [196, 255, 40], [196, 255, 40], [195, 255, 39], [195, 255, 38], [194, 255, 38], [194, 255, 37],
        [193, 255, 37], [193, 255, 36], [192, 255, 36], [192, 255, 36], [191, 255, 35], [191, 255, 35], [190, 255, 35],
        [190, 255, 35], [190, 255, 34], [189, 255, 34], [189, 255, 34], [188, 255, 34], [188, 255, 34], [188, 255, 34]
    ];

    /* ── Viridis colormap LUT (256 entries, sampled from matplotlib) ── */
    const VIRIDIS = [
        [68, 1, 84], [68, 2, 86], [69, 4, 87], [69, 5, 89], [70, 7, 90], [70, 8, 92], [70, 10, 93], [70, 11, 94],
        [71, 13, 96], [71, 14, 97], [71, 16, 99], [71, 17, 100], [71, 19, 101], [72, 20, 103], [72, 22, 104], [72, 23, 105],
        [72, 24, 106], [72, 26, 108], [72, 27, 109], [72, 28, 110], [72, 29, 111], [72, 31, 112], [72, 32, 113], [72, 33, 115],
        [72, 35, 116], [72, 36, 117], [72, 37, 118], [72, 38, 119], [72, 40, 120], [72, 41, 121], [71, 42, 122], [71, 44, 122],
        [71, 45, 123], [71, 46, 124], [71, 47, 125], [70, 48, 126], [70, 50, 126], [70, 51, 127], [70, 52, 128], [69, 53, 129],
        [69, 55, 129], [69, 56, 130], [68, 57, 131], [68, 58, 131], [68, 59, 132], [67, 61, 132], [67, 62, 133], [66, 63, 133],
        [66, 64, 134], [66, 65, 134], [65, 66, 135], [65, 68, 135], [64, 69, 136], [64, 70, 136], [63, 71, 136], [63, 72, 137],
        [62, 73, 137], [62, 74, 137], [62, 76, 138], [61, 77, 138], [61, 78, 138], [60, 79, 138], [60, 80, 139], [59, 81, 139],
        [59, 82, 139], [58, 83, 139], [58, 84, 140], [57, 85, 140], [57, 86, 140], [56, 88, 140], [56, 89, 140], [55, 90, 140],
        [55, 91, 141], [54, 92, 141], [54, 93, 141], [53, 94, 141], [53, 95, 141], [52, 96, 141], [52, 97, 141], [51, 98, 141],
        [51, 99, 141], [50, 100, 142], [50, 101, 142], [49, 102, 142], [49, 103, 142], [49, 104, 142], [48, 105, 142], [48, 106, 142],
        [47, 107, 142], [47, 108, 142], [46, 109, 142], [46, 110, 142], [46, 111, 142], [45, 112, 142], [45, 113, 142], [44, 113, 142],
        [44, 114, 142], [44, 115, 142], [43, 116, 142], [43, 117, 142], [42, 118, 142], [42, 119, 142], [42, 120, 142], [41, 121, 142],
        [41, 122, 142], [41, 123, 142], [40, 124, 142], [40, 125, 142], [39, 126, 142], [39, 127, 142], [39, 128, 142], [38, 129, 142],
        [38, 130, 142], [38, 130, 142], [37, 131, 142], [37, 132, 142], [37, 133, 142], [36, 134, 142], [36, 135, 142], [35, 136, 142],
        [35, 137, 142], [35, 138, 141], [34, 139, 141], [34, 140, 141], [34, 141, 141], [33, 142, 141], [33, 143, 141], [33, 144, 141],
        [33, 145, 140], [32, 146, 140], [32, 146, 140], [32, 147, 140], [31, 148, 140], [31, 149, 139], [31, 150, 139], [31, 151, 139],
        [31, 152, 139], [31, 153, 138], [31, 154, 138], [30, 155, 138], [30, 156, 137], [30, 157, 137], [31, 158, 137], [31, 159, 136],
        [31, 160, 136], [31, 161, 136], [31, 161, 135], [31, 162, 135], [32, 163, 134], [32, 164, 134], [33, 165, 133], [33, 166, 133],
        [34, 167, 133], [34, 168, 132], [35, 169, 131], [36, 170, 131], [37, 171, 130], [37, 172, 130], [38, 173, 129], [39, 173, 129],
        [40, 174, 128], [41, 175, 127], [42, 176, 127], [44, 177, 126], [45, 178, 125], [46, 179, 124], [47, 180, 124], [49, 181, 123],
        [50, 182, 122], [52, 182, 121], [53, 183, 121], [55, 184, 120], [56, 185, 119], [58, 186, 118], [59, 187, 117], [61, 188, 116],
        [63, 188, 115], [64, 189, 114], [66, 190, 113], [68, 191, 112], [70, 192, 111], [72, 193, 110], [74, 193, 109], [76, 194, 108],
        [78, 195, 107], [80, 196, 106], [82, 197, 105], [84, 197, 104], [86, 198, 103], [88, 199, 101], [90, 200, 100], [92, 200, 99],
        [94, 201, 98], [96, 202, 96], [99, 203, 95], [101, 203, 94], [103, 204, 92], [105, 205, 91], [108, 205, 90], [110, 206, 88],
        [112, 207, 87], [115, 208, 86], [117, 208, 84], [119, 209, 83], [122, 209, 81], [124, 210, 80], [127, 211, 78], [129, 211, 77],
        [132, 212, 75], [134, 213, 73], [137, 213, 72], [139, 214, 70], [142, 214, 69], [144, 215, 67], [147, 215, 65], [149, 216, 64],
        [152, 216, 62], [155, 217, 60], [157, 217, 59], [160, 218, 57], [162, 218, 55], [165, 219, 54], [168, 219, 52], [170, 220, 50],
        [173, 220, 48], [176, 221, 47], [178, 221, 45], [181, 222, 43], [184, 222, 41], [186, 222, 40], [189, 223, 38], [192, 223, 37],
        [194, 223, 35], [197, 224, 33], [200, 224, 32], [202, 225, 31], [205, 225, 29], [208, 225, 28], [210, 226, 27], [213, 226, 26],
        [216, 226, 25], [218, 227, 25], [221, 227, 24], [223, 227, 24], [226, 228, 24], [229, 228, 25], [231, 228, 25], [234, 229, 26],
        [236, 229, 27], [239, 229, 28], [241, 229, 29], [244, 230, 30], [246, 230, 32], [248, 230, 33], [251, 231, 35], [253, 231, 37]
    ];

    /* ── Colormap management ── */
    const COLORMAPS = { magma: MAGMA, inferno: INFERNO, viridis: VIRIDIS };
    let currentColormap = INFERNO;

    /* ── Configuration ── */
    const GRID_SCALE = 4;             // Viewport / GRID_SCALE = grid dimensions
    const CANVAS_OPACITY = 0.55;      // Canvas opacity when active
    const FPS = 30;

    // Mutable simulation parameters (can be controlled via UI)
    let diffusivity = 0.20;           // heat diffusion rate
    let decay = 0.997;                // cooling rate
    let mouseIntensity = 2.4;         // heat source strength
    let mouseRadius = 3;              // size of heat spot

    let canvas, ctx, imageData, pixels;
    let grid, nextGrid;
    let gridW, gridH;
    let animFrame = null;
    let active = false;
    let lastTime = 0;
    const frameInterval = 1000 / FPS;

    // Mouse tracking
    let pointer = { x: -1, y: -1, active: false };

    // Event listener management
    let listenersAttached = false;

    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }

    /* ── Initialize grid ── */
    function initGrid() {
        // Calculate grid dimensions based on viewport
        gridW = Math.floor(window.innerWidth / GRID_SCALE);
        gridH = Math.floor(window.innerHeight / GRID_SCALE);

        grid = new Float32Array(gridW * gridH);
        nextGrid = new Float32Array(gridW * gridH);
        grid.fill(0);
    }

    /* ── Handle Mouse/Touch Events ── */
    function updatePointer(clientX, clientY) {
        if (!canvas || !gridW || !gridH) return;

        // Map viewport coordinates directly to grid coordinates
        const x = Math.floor((clientX / window.innerWidth) * gridW);
        const y = Math.floor((clientY / window.innerHeight) * gridH);

        // Ensure coordinates are valid
        if (isNaN(x) || isNaN(y)) return;

        pointer.x = Math.max(0, Math.min(gridW - 1, x));
        pointer.y = Math.max(0, Math.min(gridH - 1, y));
        pointer.active = true;
    }

    function onMouseMove(e) {
        if (!active) return;
        updatePointer(e.clientX, e.clientY);
    }

    function onTouchMove(e) {
        if (!active || e.touches.length === 0) return;
        updatePointer(e.touches[0].clientX, e.touches[0].clientY);
    }

    /* ── Handle window resize ── */
    function handleResize() {
        if (!active || !canvas) return;

        // Recalculate grid dimensions
        const newGridW = Math.floor(window.innerWidth / GRID_SCALE);
        const newGridH = Math.floor(window.innerHeight / GRID_SCALE);

        // Only reinitialize if dimensions actually changed
        if (newGridW !== gridW || newGridH !== gridH) {
            gridW = newGridW;
            gridH = newGridH;

            // Update canvas size
            canvas.width = gridW;
            canvas.height = gridH;

            // Reinitialize grids (clears existing heat)
            grid = new Float32Array(gridW * gridH);
            nextGrid = new Float32Array(gridW * gridH);
            grid.fill(0);

            // Recreate image data
            imageData = ctx.createImageData(gridW, gridH);
            pixels = imageData.data;
        }
    }

    /* ── Apply heat from mouse ── */
    function applySources() {
        // If mouse is active and on grid
        if (pointer.active && pointer.x >= 0 && pointer.x < gridW && pointer.y >= 0 && pointer.y < gridH) {
            const r = mouseRadius;
            // Inject heat at pointer location
            for (let dy = -r; dy <= r; dy++) {
                for (let dx = -r; dx <= r; dx++) {
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > r) continue;

                    const gx = pointer.x + dx;
                    const gy = pointer.y + dy;

                    if (gx >= 0 && gx < gridW && gy >= 0 && gy < gridH) {
                        const idx = gy * gridW + gx;
                        // Add heat, clamp at max 2.0 to allow "overheating" visual
                        grid[idx] = Math.min(2.0, grid[idx] + mouseIntensity * 0.2);
                    }
                }
            }
        }
    }

    /* ── Diffuse one step (explicit finite-difference) ── */
    function diffuseStep() {
        for (let y = 1; y < gridH - 1; y++) {
            for (let x = 1; x < gridW - 1; x++) {
                const idx = y * gridW + x;
                const laplacian =
                    grid[idx - 1] + grid[idx + 1] +
                    grid[idx - gridW] + grid[idx + gridW] -
                    4 * grid[idx];

                const nextValue = (grid[idx] + diffusivity * laplacian) * decay;
                nextGrid[idx] = Number.isFinite(nextValue) ? Math.max(0, nextValue) : 0;
            }
        }

        // Swap buffers
        const tmp = grid;
        grid = nextGrid;
        nextGrid = tmp;
    }

    /* ── Render grid to canvas using current colormap ── */
    function render() {
        if (!ctx || !imageData || !pixels || !grid || !currentColormap) return;

        for (let i = 0; i < gridW * gridH; i++) {
            // Clamp value for rendering (0.0 to 1.0)
            const val = clamp(Number.isFinite(grid[i]) ? grid[i] : 0, 0, 1);

            // Non-linear mapping for more contrast
            const mapped = Math.pow(val, 0.5);
            const lutIdx = clamp(Math.floor(mapped * 255), 0, 255);
            const color = currentColormap[lutIdx] || [0, 0, 0];
            const [r, g, b] = color;

            const pi = i * 4;
            pixels[pi] = r;
            pixels[pi + 1] = g;
            pixels[pi + 2] = b;

            // Dynamic alpha: empty areas are transparent, hot areas valid opacity
            pixels[pi + 3] = (val > 0.01) ? 255 : 0;
        }
        ctx.putImageData(imageData, 0, 0);
    }

    /* ── Animation loop ── */
    function animate(timestamp) {
        if (!active) return;
        if (!grid || !nextGrid || !ctx || !imageData || !pixels) {
            animFrame = requestAnimationFrame(animate);
            return;
        }

        if (timestamp - lastTime < frameInterval) {
            animFrame = requestAnimationFrame(animate);
            return;
        }
        lastTime = timestamp;

        applySources(); // Inject mouse heat

        // Multiple steps for fast fluid visuals
        diffuseStep();
        diffuseStep();
        diffuseStep();

        render();
        animFrame = requestAnimationFrame(animate);
    }

    /* ── Event listener management ── */
    function attachListeners() {
        if (!listenersAttached) {
            document.addEventListener('mousemove', onMouseMove, { passive: true });
            document.addEventListener('touchmove', onTouchMove, { passive: true });
            window.addEventListener('resize', handleResize, { passive: true });
            listenersAttached = true;
        }
    }

    function removeListeners() {
        if (listenersAttached) {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('touchmove', onTouchMove);
            window.removeEventListener('resize', handleResize);
            listenersAttached = false;
        }
        pointer.active = false;
    }

    /* ── Start / Stop ── */
    function start() {
        if (active) return;

        if (!canvas) {
            canvas = document.getElementById('thermal-canvas');
            if (!canvas) {
                active = false;
                return;
            }
            ctx = canvas.getContext('2d');
            if (!ctx) {
                active = false;
                return;
            }
        }

        initGrid();

        // Set canvas dimensions to match grid
        canvas.width = gridW;
        canvas.height = gridH;

        // Create image data
        imageData = ctx.createImageData(gridW, gridH);
        pixels = imageData.data;

        canvas.style.opacity = CANVAS_OPACITY;

        // Ensure pointer starts active
        pointer.active = true;

        // Attach event listeners
        attachListeners();

        active = true;
        lastTime = 0;
        animFrame = requestAnimationFrame(animate);
    }

    function stop() {
        active = false;
        if (animFrame) {
            cancelAnimationFrame(animFrame);
            animFrame = null;
        }
        if (canvas) {
            canvas.style.opacity = '0';
        }

        // Remove listeners
        removeListeners();
    }

    /* ── Parameter control API ── */
    function setParameter(name, value) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return;

        switch (name) {
            case 'diffusivity':
                diffusivity = clamp(numeric, 0.0, 0.5);
                break;
            case 'decay':
                decay = clamp(numeric, 0.95, 0.999);
                break;
            case 'mouseIntensity':
                mouseIntensity = clamp(numeric, 0.5, 5.0);
                break;
            case 'mouseRadius':
                mouseRadius = Math.round(clamp(numeric, 1, 10));
                break;
        }
    }

    function setColormap(name) {
        if (COLORMAPS[name]) {
            currentColormap = COLORMAPS[name];
        }
    }

    /* ── Expose to main.js ── */
    window.thermalCanvas = {
        start,
        stop,
        setParameter,
        setColormap
    };

})();
